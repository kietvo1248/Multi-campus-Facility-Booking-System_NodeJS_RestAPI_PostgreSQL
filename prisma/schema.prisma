// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums

enum UserRole {
  ADMIN
  LECTURER
  STUDENT
  FACILITY_ADMIN
  SECURITY_GUARD
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  COMPLETED
  PREEMPTED
  CONFLICT
}

enum ReportCategory {
  DAMAGE
  INCIDENT
}

// ✅ NEW: condition for facility equipments (lowercase only)
enum EquipmentCondition {
  good
  poor
}

// Models

model Campus {
  id        Int      @id @default(autoincrement())
  name      String
  address   String?
  isActive  Boolean  @default(true)

  // Relations
  users      User[]
  clubs      Club[]
  facilities Facility[]

  @@map("campuses")
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  passwordHash  String?
  fullName      String
  role          UserRole
  googleId      String?  @unique
  phoneNumber   String?
  isActive      Boolean  @default(true)
  campusId      Int

  // Relations
  campus               Campus    @relation(fields: [campusId], references: [id])
  bookings             Booking[]
  reports              Report[]

  managedClub          Club?

  historyChanges       BookingHistory[]
  maintenanceReported  MaintenanceLog[]
  createdBookingGroups BookingGroup[]

  // ✅ Optional: if you want to link equipment history to user (editor)
  equipmentHistories   FacilityEquipmentHistory[] @relation("EquipmentHistoryCreatedBy")

  @@map("users")
}

model BookingType {
  id             Int     @id @default(autoincrement())
  name           String
  priorityWeight Int
  description    String?

  bookings Booking[]

  @@map("booking_types")
}

model Club {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?

  campusId    Int
  leaderId    Int?     @unique

  campus      Campus         @relation(fields: [campusId], references: [id])
  leader      User?          @relation(fields: [leaderId], references: [id])
  priorities  ClubPriority[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("clubs")
}

model ClubPriority {
  id            Int      @id @default(autoincrement())
  clubId        Int
  facilityId    Int

  priorityScore Int      @default(0)
  note          String?

  club          Club     @relation(fields: [clubId], references: [id])
  facility      Facility @relation(fields: [facilityId], references: [id])

  @@unique([clubId, facilityId])
  @@map("club_priorities")
}

model FacilityType {
  id          Int     @id @default(autoincrement())
  name        String
  description String?

  facilities Facility[]

  isActive    Boolean @default(true) @map("is_active")

  @@map("facility_types")
}

model Facility {
  id          Int      @id @default(autoincrement())
  name        String
  capacity    Int
  imageUrls   Json?
  status      String
  description String?
  campusId    Int
  typeId      Int

  campus      Campus              @relation(fields: [campusId], references: [id])
  type        FacilityType        @relation(fields: [typeId], references: [id])
  equipment   FacilityEquipment[]
  priorities  ClubPriority[]
  bookings    Booking[]
  maintenance MaintenanceLog[]
  reports     Report[]

  relocatedHistories BookingHistory[]

  // ✅ history relation (optional but useful)
  equipmentHistories FacilityEquipmentHistory[]

  @@map("facilities")
}

model EquipmentType {
  id       Int     @id @default(autoincrement())
  name     String
  iconUrl  String?
  category String?

  equipment FacilityEquipment[]

  // ✅ history relation (optional but useful)
  equipmentHistories FacilityEquipmentHistory[]

  @@map("equipment_types")
}

model FacilityEquipment {
  facilityId      Int
  equipmentTypeId Int

  // ✅ CHANGED: String -> EquipmentCondition (lowercase)
  condition       EquipmentCondition

  quantity        Int

  facility      Facility      @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  equipmentType EquipmentType @relation(fields: [equipmentTypeId], references: [id], onDelete: Cascade)

  @@id([facilityId, equipmentTypeId, condition])
  @@map("facility_equipments")
}

// ✅ NEW: History table for add/update/delete equipment in a facility
model FacilityEquipmentHistory {
  id              Int              @id @default(autoincrement())

  facilityId      Int
  equipmentTypeId Int

  action          String           // "ADD" | "UPDATE" | "DELETE"
  note            String?          // you can enforce required for UPDATE in service

  oldQuantity     Int?
  newQuantity     Int?

  oldCondition    EquipmentCondition?
  newCondition    EquipmentCondition?

  createdById     Int?
  createdAt       DateTime         @default(now())

  // Relations
  facility        Facility         @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  equipmentType   EquipmentType    @relation(fields: [equipmentTypeId], references: [id], onDelete: Cascade)

  createdBy       User?            @relation("EquipmentHistoryCreatedBy", fields: [createdById], references: [id])

  @@index([facilityId, equipmentTypeId])
  @@map("facility_equipment_histories")
}

model BookingGroup {
  id          Int      @id @default(autoincrement())
  description String?
  totalSlots  Int
  createdAt   DateTime @default(now())

  createdById Int
  createdBy   User     @relation(fields: [createdById], references: [id])

  bookings Booking[]

  @@map("booking_groups")
}

model Booking {
  id             Int           @id @default(autoincrement())
  startTime      DateTime
  endTime        DateTime
  status         BookingStatus @default(PENDING)
  attendeeCount  Int?
  isCheckedIn    Boolean       @default(false)

  userId         Int
  facilityId     Int
  bookingGroupId Int?
  bookingTypeId  Int

  // ✅ NEW: Booking này là "đổi lịch từ booking nào"
  rescheduleFromId Int?
  rescheduleFrom   Booking? @relation("BookingReschedule", fields: [rescheduleFromId], references: [id], onDelete: SetNull)
  rescheduledTo    Booking[] @relation("BookingReschedule")

  user         User          @relation(fields: [userId], references: [id])
  facility     Facility      @relation(fields: [facilityId], references: [id])
  group        BookingGroup? @relation(fields: [bookingGroupId], references: [id])
  bookingType  BookingType   @relation(fields: [bookingTypeId], references: [id])

  history      BookingHistory[]
  reports      Report[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rescheduleFromId])
  @@map("bookings")
}


model BookingHistory {
  id                 Int           @id @default(autoincrement())
  bookingId          Int

  oldStatus          BookingStatus
  newStatus          BookingStatus
  changeReason       String?

  previousFacilityId Int?
  changedById        Int

  booking          Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  previousFacility Facility?  @relation(fields: [previousFacilityId], references: [id])
  changedBy        User       @relation(fields: [changedById], references: [id])

  updatedAt DateTime @default(now())

  @@map("booking_histories")
}

model MaintenanceLog {
  id           Int      @id @default(autoincrement())
  startDate    DateTime
  endDate      DateTime?
  reason       String?
  status       String
  facilityId   Int
  reportedById Int

  facility   Facility @relation(fields: [facilityId], references: [id])
  reportedBy User     @relation(fields: [reportedById], references: [id])

  @@map("maintenance_logs")
}

model Report {
  id          Int            @id @default(autoincrement())
  title       String
  description String?
  status      String
  category    ReportCategory
  imageUrls   Json?

  facilityId  Int
  reporterId  Int
  bookingId   Int?

  facility Facility @relation(fields: [facilityId], references: [id])
  reporter User     @relation(fields: [reporterId], references: [id])
  booking  Booking? @relation(fields: [bookingId], references: [id])

  createdAt DateTime @default(now())

  @@map("reports")
}
