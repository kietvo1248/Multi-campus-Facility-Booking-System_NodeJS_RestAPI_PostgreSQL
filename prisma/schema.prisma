// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
// Enums (Định nghĩa các tập giá trị cố định)

enum UserRole {
  ADMIN
  LECTURER
  STAFF
  STUDENT
  CLUB_LEADER
  SECURITY
}

enum BookingStatus {
  PENDING     // Chờ duyệt
  APPROVED    // Đã duyệt
  REJECTED    // Admin từ chối
  CANCELLED   // User tự hủy
  COMPLETED   // Đã xong
  PREEMPTED   // [Logic] Bị hủy do sự kiện ưu tiên cao hơn chiếm chỗ
  CONFLICT    // [Logic] Bị trùng lịch ngay lúc tạo (cho tuần thứ 7 bị kẹt)
}

enum ReportCategory {
  DAMAGE      // Hư hại cơ sở vật chất (lúc đi tuần)
  INCIDENT    // Sự cố, xô xát (trong booking)
}

// 3. Models (Các bảng)

model Campus {
  id        Int      @id @default(autoincrement())
  name      String
  address   String?
  isActive  Boolean  @default(true)
  
  // Relations
  users      User[]
  clubs      Club[]
  facilities Facility[]

  @@map("campuses")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  fullName     String
  role         UserRole
  phoneNumber  String?
  isActive     Boolean  @default(true)
  campusId     Int
  
  // Relations
  campus              Campus    @relation(fields: [campusId], references: [id])
  bookings            Booking[]
  reports             Report[]
  
  // Quan hệ 1-1: User là Leader của 1 Club (Optional vì không phải ai cũng là Leader)
  managedClub         Club?     
  
  // History tracking
  historyChanges      BookingHistory[]
  maintenanceReported MaintenanceLog[]

  @@map("users")
}

model Club {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  campusId    Int
  leaderId    Int     @unique // Unique để đảm bảo 1 user chỉ lead 1 club
  
  // Relations
  campus     Campus         @relation(fields: [campusId], references: [id])
  leader     User           @relation(fields: [leaderId], references: [id])
  priorities ClubPriority[]

  @@map("clubs")
}

// [LOGIC 1] Độ ưu tiên theo LOẠI HÌNH HOẠT ĐỘNG (Event > Class > Meeting)
model BookingType {
  id             Int     @id @default(autoincrement())
  name           String  // VD: "Sự kiện", "Lớp học"
  priorityWeight Int     // VD: 100, 80
  description    String?

  bookings Booking[]

  @@map("booking_types")
}

// [LOGIC 1] Độ ưu tiên theo ĐẶC QUYỀN CLB (Club A sở hữu Phòng B)
model ClubPriority {
  clubId        Int
  facilityId    Int
  priorityScore Int @default(10) // Điểm cộng thêm

  // Relations
  club     Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  // Composite Key (Khóa chính phức hợp)
  @@id([clubId, facilityId])
  @@map("club_priorities")
}

model FacilityType {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  
  facilities Facility[]

  @@map("facility_types")
}

model Facility {
  id          Int      @id @default(autoincrement())
  name        String
  capacity    Int
  imageUrls   Json?    // Lưu mảng string url
  status      String   // Có thể chuyển thành Enum nếu muốn (AVAILABLE, MAINTAINANCE)
  description String?
  campusId    Int
  typeId      Int

  // Relations
  campus      Campus              @relation(fields: [campusId], references: [id])
  type        FacilityType        @relation(fields: [typeId], references: [id])
  equipment   FacilityEquipment[]
  priorities  ClubPriority[]
  bookings    Booking[]
  maintenance MaintenanceLog[]
  reports     Report[]
  
  // Dùng cho BookingHistory để biết chuyển từ phòng nào
  relocatedHistories BookingHistory[] 

  @@map("facilities")
}

model EquipmentType {
  id       Int     @id @default(autoincrement())
  name     String
  iconUrl  String?
  category String?

  equipment FacilityEquipment[]

  @@map("equipment_types")
}

model FacilityEquipment {
  facilityId      Int
  equipmentTypeId Int
  condition       String // VD: "Good", "Broken"
  quantity        Int

  // Relations
  facility      Facility      @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  equipmentType EquipmentType @relation(fields: [equipmentTypeId], references: [id], onDelete: Cascade)

  @@id([facilityId, equipmentTypeId, condition])
  @@map("facility_equipments")
}

// [LOGIC 4] Nhóm Booking (Cho việc đặt 10 tuần)
model BookingGroup {
  id          Int      @id @default(autoincrement())
  description String?
  totalSlots  Int
  createdAt   DateTime @default(now())

  bookings Booking[]

  @@map("booking_groups")
}

model Booking {
  id             Int           @id @default(autoincrement())
  startTime      DateTime
  endTime        DateTime
  status         BookingStatus @default(PENDING)
  attendeeCount  Int?
  
  // Foreign Keys
  userId         Int
  facilityId     Int
  bookingGroupId Int?          // Nullable vì có thể đặt lẻ 1 buổi
  bookingTypeId  Int

  // Relations
  user         User          @relation(fields: [userId], references: [id])
  facility     Facility      @relation(fields: [facilityId], references: [id])
  group        BookingGroup? @relation(fields: [bookingGroupId], references: [id])
  bookingType  BookingType   @relation(fields: [bookingTypeId], references: [id])
  
  history      BookingHistory[]
  reports      Report[] // [Logic 2] Sự cố xảy ra trong booking này

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bookings")
}

model BookingHistory {
  id                 Int           @id @default(autoincrement())
  bookingId          Int
  
  oldStatus          BookingStatus
  newStatus          BookingStatus
  changeReason       String?       // [Logic 3] Ghi lý do bị PREEMPTED
  
  previousFacilityId Int?          // [Logic 4] Lưu ID phòng cũ nếu bị đổi phòng
  changedById        Int           // Người thực hiện thay đổi

  // Relations
  booking          Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  previousFacility Facility? @relation(fields: [previousFacilityId], references: [id])
  changedBy        User      @relation(fields: [changedById], references: [id])

  updatedAt DateTime @default(now())

  @@map("booking_histories")
}

model MaintenanceLog {
  id          Int      @id @default(autoincrement())
  startDate   DateTime
  endDate     DateTime?
  reason      String?
  status      String
  facilityId  Int
  reportedById Int

  facility   Facility @relation(fields: [facilityId], references: [id])
  reportedBy User     @relation(fields: [reportedById], references: [id])

  @@map("maintenance_logs")
}

// [LOGIC 2] Báo cáo linh hoạt
model Report {
  id          Int            @id @default(autoincrement())
  title       String
  description String?
  status      String         // Pending, Processing, Done
  category    ReportCategory
  imageUrls   Json?
  
  facilityId  Int
  reporterId  Int
  bookingId   Int?           // Nullable: Null = đi tuần thấy, Có ID = sự cố trong booking

  // Relations
  facility Facility @relation(fields: [facilityId], references: [id])
  reporter User     @relation(fields: [reporterId], references: [id])
  booking  Booking? @relation(fields: [bookingId], references: [id])

  createdAt DateTime @default(now())

  @@map("reports")
}