openapi: 3.0.0
info:
  title: FPTU Facility Booking System API
  description: |
    Tài liệu API hệ thống đặt phòng FPTU.
    
    ### Workflow Legend (Chú giải quy trình)
    * **MW1**: Đặt phòng ngắn hạn (Student)
    * **MW2**: Đặt phòng định kỳ (Lecturer)
    * **MW3**: Đặt phòng sự kiện (Club)
    * **MW4**: Duyệt đơn & Xử lý xung đột
    * **MW5**: Check-in/Check-out (Bảo vệ)
    * **MW6**: Bảo trì & Chuyển phòng
    * **MW7**: Hủy đặt phòng
    * **SW1**: Quản lý Tài nguyên (Phòng/Thiết bị)
    * **SW2**: Quản lý CLB & Phân quyền
    * **SW4**: Báo cáo sự cố
    * **SW5**: Quản lý nhân sự
    * **SW6**: Thống kê (Dashboard)
  version: 3.3.0
servers:
  - url: https://multi-campus-facility-booking-system-vh0n.onrender.com/api
    description: Production Server (Render)
  - url: http://localhost:6969/api
    description: Local Development Server

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: access_token
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- AUTH & USER ---
    LoginInput:
      type: object
      required: [email, password, campusId]
      properties:
        email: { type: string, format: email, example: "admin@fpt.edu.vn" }
        password: { type: string, format: password, example: "123456" }
        campusId: { type: integer, example: 2 }

    LoginResponse:
      type: object
      properties:
        message: { type: string }
        token: { type: string }
        user: 
          type: object
          properties:
            id: { type: integer }
            fullName: { type: string }
            role: { type: string }
            campusName: { type: string }

    UpdateProfileInput:
      type: object
      properties:
        fullName: { type: string }
        phoneNumber: { type: string }

    ChangePasswordInput:
      type: object
      required: [currentPassword, newPassword, confirmPassword]
      properties:
        currentPassword: { type: string }
        newPassword: { type: string }
        confirmPassword: { type: string }

    ToggleUserStatusInput:
      type: object
      required: [isActive]
      properties:
        isActive: { type: boolean }

    # --- RESOURCES ---
    CampusInput:
      type: object
      required: [name]
      properties:
        name: { type: string }
        address: { type: string }

    FacilityTypeInput:
      type: object
      required: [name]
      properties:
        name: { type: string }
        description: { type: string }

    FacilityInput:
      type: object
      required: [name, campusId, typeId, capacity]
      properties:
        name: { type: string }
        capacity: { type: integer }
        campusId: { type: integer }
        typeId: { type: integer }
        description: { type: string }
        status: { type: string, enum: [ACTIVE, INACTIVE, MAINTENANCE] }
        imageUrls: { type: array, items: { type: string } }

    ClubInput:
      type: object
      required: [code, name, campusId]
      properties:
        code: { type: string }
        name: { type: string }
        campusId: { type: integer }
        leaderEmail: { type: string, description: "Email sinh viên làm Leader" }

    ClubPriorityInput:
      type: object
      required: [facilityId, priorityScore]
      properties:
        facilityId: { type: integer }
        priorityScore: { type: integer }
        note: { type: string }

    EquipmentTypeCreate:
      type: object
      required: [name, category]
      properties:
        name: { type: string }
        iconUrl: { type: string }
        category: { type: string }

    FacilityEquipmentAdd:
      type: object
      required: [equipmentTypeId, quantity]
      properties:
        equipmentTypeId: { type: integer }
        quantity: { type: integer }
        condition: { type: string }

    FacilityEquipmentUpdate:
      type: object
      properties:
        quantity: { type: integer }
        newCondition: { type: string }

    # --- BOOKING & PROCESS ---
    BookingInput:
      type: object
      required: [facilityId, date, slots, bookingTypeId]
      properties:
        facilityId: { type: integer }
        date: { type: string, format: date, example: "2025-10-20" }
        slots: { type: array, items: { type: integer }, example: [1, 2] }
        bookingTypeId: { type: integer }
        purpose: { type: string }
        attendeeCount: { type: integer }

    RecurringScanInput:
      type: object
      required: [originalFacilityId, startDate, weeks, slot]
      properties:
        originalFacilityId: { type: integer }
        startDate: { type: string, format: date }
        weeks: { type: integer, example: 10 }
        slot: { type: array, items: { type: integer } }
        capacity: { type: integer }
        typeId: { type: integer }

    RecurringCreateInput:
      type: object
      required: [note, bookings]
      properties:
        note: { type: string }
        bookings: 
          type: array
          items:
            type: object
            properties:
              facilityId: { type: integer }
              bookingTypeId: { type: integer }
              startTime: { type: string, format: date-time }
              endTime: { type: string, format: date-time }
              attendeeCount: { type: integer }

    RejectInput:
      type: object
      required: [reason]
      properties:
        reason: { type: string }

    RelocateInput:
      type: object
      required: [newFacilityId]
      properties:
        newFacilityId: { type: integer }
        reason: { type: string }

    MaintenanceSetRequest:
      type: object
      required: [facilityId, startDate, reason]
      properties:
        facilityId: { type: integer }
        startDate: { type: string, format: date-time }
        endDate: { type: string, format: date-time }
        reason: { type: string }

    ReportCreateBooking:
      type: object
      required: [bookingId]
      properties:
        bookingId: { type: integer }
        title: { type: string }
        description: { type: string }
        category: { type: string, example: 'INCIDENT' }
        imageUrls: { type: array, items: { type: string } }

    ReportCreateFacility:
      type: object
      properties:
        title: { type: string }
        description: { type: string }
        category: { type: string, example: 'DAMAGE' }
        imageUrls: { type: array, items: { type: string } }

paths:
  # ==========================================
  # TAG 1: PUBLIC & COMMON (All Roles)
  # ==========================================
  /auth/login:
    post:
      summary: "[MW1] Đăng nhập thường (Email/Pass)"
      tags: [1. Public & Common]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginInput' }
      responses:
        '200':
          content:
            application/json:
              schema: { $ref: '#/components/schemas/LoginResponse' }

  /auth/google/login:
    get:
      summary: "[MW1] Đăng nhập Google (Redirect)"
      tags: [1. Public & Common]
      parameters:
        - in: query
          name: campusId
          schema: { type: integer }
      responses:
        '302': { description: Redirect to Google }

  /auth/profile:
    get:
      summary: "[MW1] Xem thông tin bản thân"
      tags: [1. Public & Common]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: OK }

  /users/update-profile:
    patch:
      summary: "[MW1] Cập nhật thông tin cá nhân"
      tags: [1. Public & Common]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpdateProfileInput' }
      responses:
        '200': { description: Updated }

  /users/change-password:
    patch:
      summary: "[MW1] Đổi mật khẩu"
      tags: [1. Public & Common]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ChangePasswordInput' }
      responses:
        '200': { description: Success }

  # ==========================================
  # TAG 2: STUDENT & LECTURER (Booking Basics)
  # ==========================================
  /bookings/search:
    get:
      summary: "[MW1.1] Tìm kiếm phòng trống"
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: date
          required: true
          schema: { type: string, format: date }
        - in: query
          name: slot
          required: true
          schema: { type: integer }
        - in: query
          name: typeId
          schema: { type: integer }
        - in: query
          name: capacity
          schema: { type: integer }
      responses:
        '200':
          description: List Available Facilities
          content:
            application/json:
              example:
                - id: 101
                  name: "R101"
                  capacity: 30
                  type: { name: "Phòng học" }

  /bookings:
    post:
      summary: "[MW1.3] Tạo Booking (Short-term)"
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BookingInput' }
      responses:
        '201':
          description: Created (PENDING)
          content:
            application/json:
              example:
                id: 555
                status: "PENDING"
                facilityId: 101

  /bookings/me:
    get:
      summary: "[MW1] Xem lịch sử đặt phòng của tôi"
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: OK }

  /bookings/{id}:
    get:
      summary: "[MW1] Xem chi tiết booking"
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /bookings/facility-schedule:
    get:
      summary: Xem trạng thái các Slot của 1 phòng (Grid View)
      description: API này trả về trạng thái (Available/Booked/Maintenance) của từng slot trong ngày để vẽ giao diện chọn giờ.
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: facilityId
          required: true
          schema: { type: integer }
        - in: query
          name: date
          required: true
          schema: { type: string, format: date, example: "2025-10-25" }
      responses:
        '200':
          description: OK
          content:
            application/json:
              example:
                - slotId: 1
                  startTime: "07:00"
                  endTime: "09:00"
                  status: "AVAILABLE"
                - slotId: 2
                  startTime: "09:00"
                  endTime: "11:00"
                  status: "BOOKED"
                  details: { status: "APPROVED" }
                - slotId: 3
                  startTime: "13:00"
                  endTime: "15:00"
                  status: "MY_BOOKING"

  /bookings/{id}/cancel:
    patch:
      summary: "[MW7] Tự hủy đặt phòng"
      description: Chỉ hủy được trước 30 phút.
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Cancelled }

  # ==========================================
  # TAG 3: LECTURER SPECIFIC
  # ==========================================
  /bookings/recurring/scan:
    post:
      summary: "[MW2.2] Scan tính khả dụng cho lịch định kỳ"
      tags: [3. Lecturer Specific]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RecurringScanInput' }
      responses:
        '200':
          description: Result Plan
          content:
            application/json:
              example:
                - week: 1
                  date: "2023-10-01"
                  status: "AVAILABLE"
                  facilityName: "R101"
                - week: 2
                  date: "2023-10-08"
                  status: "CONFLICT_RESOLVED"
                  facilityName: "R102 (Thay thế)"

  /bookings/recurring:
    post:
      summary: "[MW2.4] Tạo Booking định kỳ (Transaction)"
      tags: [3. Lecturer Specific]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RecurringCreateInput' }
      responses:
        '201': { description: Created Group & Bookings }

  # ==========================================
  # TAG 4: CLUB LEADER
  # ==========================================
  /bookings/club-suggestions:
    get:
      summary: "[MW3.2] Gợi ý phòng ưu tiên cho CLB"
      tags: [4. Club Leader]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: date
          required: true
          schema: { type: string, format: date }
        - in: query
          name: slot
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }

  # ==========================================
  # TAG 5: ADMIN - BOOKING OPERATIONS
  # ==========================================
  /bookings/pending-approvals:
    get:
      summary: "[MW4.1] Xem danh sách chờ duyệt"
      tags: [5. Admin - Booking Ops]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: campusId
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /bookings/all-bookings:
    get:
      summary: "[MỚI] Xem tất cả đơn đặt phòng"
      tags: [5. Admin - Booking Ops]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: campusId
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /bookings/conflicts:
    get:
      summary: "[MW4.1] Xem danh sách xung đột"
      tags: [5. Admin - Booking Ops]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: campusId
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /bookings/{id}/approve:
    patch:
      summary: "[MW4.2] Duyệt đơn (Auto Reject Conflicts)"
      tags: [5. Admin - Booking Ops]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Approved }

  /bookings/{id}/reject:
    patch:
      summary: "[MW4.2] Từ chối đơn"
      tags: [5. Admin - Booking Ops]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RejectInput' }
      responses:
        '200': { description: Rejected }

  /bookings/{id}/move:
    patch:
      summary: "[MW6] Dời lịch thủ công"
      description: Dùng khi xử lý sự cố hoặc bảo trì.
      tags: [5. Admin - Booking Ops]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RelocateInput' }
      responses:
        '200': { description: Relocated }

  # ==========================================
  # TAG 6: ADMIN - RESOURCES & MAINTENANCE
  # ==========================================
  /maintenance/check-impact:
    get:
      summary: "[MW6.1] Kiểm tra va chạm trước khi bảo trì"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: facilityId
          required: true
          schema: { type: integer }
        - in: query
          name: startDate
          required: true
          schema: { type: string, format: date-time }
        - in: query
          name: endDate
          required: true
          schema: { type: string, format: date-time }
      responses:
        '200':
          description: List of impacted bookings
          content:
            application/json:
              example:
                totalConflicts: 2
                conflicts: [{ id: 1, userId: 5, startTime: "..." }]

  /maintenance/set:
    post:
      summary: "[MW6.1] Thiết lập Bảo trì & Auto chuyển phòng (Cũ)"
      description: Lưu ý nên dùng check-impact và move thủ công trước.
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MaintenanceSetRequest' }
      responses:
        '200': { description: Processed }

  # --- SW5: User Management ---
  /users:
    get:
      summary: "[SW5] Danh sách nhân sự/người dùng"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: role
          schema: { type: string }
        - in: query
          name: keyword
          schema: { type: string }
      responses:
        '200': { description: OK }

  /users/{id}/status:
    patch:
      summary: "[SW5] Khóa/Mở khóa tài khoản"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ToggleUserStatusInput' }
      responses:
        '200': { description: Updated }

  # --- SW1: Facility & Equipment CRUD ---
  /resources/facilities:
    get:
      summary: "[SW1] Xem danh sách phòng"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: typeId
          schema: { type: integer }
      responses:
        '200': { description: OK }
    post:
      summary: "[SW1] Tạo phòng mới"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityInput' }
      responses:
        '201': { description: Created }

  /resources/facilities/{id}:
    put:
      summary: "[SW1] Cập nhật phòng"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityInput' }
      responses:
        '200': { description: Updated }
    delete:
      summary: "[SW1] Xóa phòng (Soft Delete)"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: integer }
      responses:
        '200': { description: Deleted }

  /equipment/types:
    get:
      summary: "[SW1] Danh sách loại thiết bị"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: OK }
    post:
      summary: "[SW1] Tạo loại thiết bị mới"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EquipmentTypeCreate' }
      responses:
        '201': { description: Created }

  /equipment/facilities/{facilityId}:
    get:
      summary: "[SW1] Danh sách thiết bị của phòng"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: facilityId
          schema: { type: integer }
          required: true
      responses:
        '200': { description: OK }
    post:
      summary: "[SW1] Thêm thiết bị vào phòng"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: facilityId
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityEquipmentAdd' }
      responses:
        '201': { description: Added }

  # --- SW2: Club Management ---
  /clubs:
    get:
      summary: "[SW2] Danh sách CLB"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: campusId
          schema: { type: integer }
      responses:
        '200': { description: OK }
    post:
      summary: "[SW2] Tạo CLB & Gán Leader"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClubInput' }
      responses:
        '201': { description: Created }

  /clubs/{id}/priorities:
    post:
      summary: "[SW2] Gán phòng ưu tiên"
      tags: [6. Admin - Resources & Maint]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClubPriorityInput' }
      responses:
        '200': { description: Assigned }

  # ==========================================
  # TAG 7: SECURITY GUARD
  # ==========================================
  /bookings/guard/search:
    get:
      summary: "[MW5.1] Tìm đơn Check-in"
      description: Tìm theo Tên SV, Mã Booking. Chỉ hiện đơn APPROVED trong ngày.
      tags: [7. Security Guard]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: keyword
          schema: { type: string }
      responses:
        '200': { description: OK }

  /bookings/{id}/check-in:
    patch:
      summary: "[MW5.2] Mở cửa / Check-in"
      tags: [7. Security Guard]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /bookings/{id}/check-out:
    patch:
      summary: "[MW5.3] Đóng cửa / Check-out"
      tags: [7. Security Guard]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /reports/facility/{facilityId}:
    post:
      summary: "[SW4] Báo cáo sự cố phòng"
      tags: [7. Security Guard]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: facilityId
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ReportCreateFacility' }
      responses:
        '201': { description: Reported }

  # ==========================================
  # TAG 8: ANALYTICS (Campus Admin)
  # ==========================================
  /analytics/dashboard:
    get:
      summary: "[SW6] Dashboard & Thống kê"
      tags: [8. Analytics]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: startDate
          schema: { type: string, format: date-time }
        - in: query
          name: endDate
          schema: { type: string, format: date-time }
      responses:
        '200':
          description: Analytics Data
          content:
            application/json:
              example:
                overview: { total: 150, breakdown: { APPROVED: 100 } }
                rates: { cancellationRate: 5.5, occupancyRate: 60 }
                topFacilities: []