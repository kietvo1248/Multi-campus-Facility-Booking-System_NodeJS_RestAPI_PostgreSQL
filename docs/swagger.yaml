openapi: 3.0.0
info:
  title: FPTU Facility Booking System API
  description: |
    Tài liệu API hệ thống đặt phòng FPTU.
    
    ### Hướng dẫn sử dụng theo Role
    * **1. Public & Common**: Dành cho tất cả User (Login, Profile, Đổi pass).
    * **2. Student & Lecturer**: Tìm phòng, Xem chi tiết phòng, Đặt phòng (Học/Họp).
    * **3. Club Leader**: Các tính năng mở rộng cho chủ nhiệm CLB (Gợi ý phòng ưu tiên).
    * **4. Admin Operations**: Dành cho Admin (Duyệt đơn, Bảo trì, Quản lý tài nguyên).
    * **5. Security Guard**: Dành cho Bảo vệ (Check-in/Out).
  version: 3.1.0
servers:
  - url: http://localhost:6969/api
    description: Local Development Server

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: access_token
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- INPUT MODELS ---
    LoginInput:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: "admin@fpt.edu.vn" }
        password: { type: string, format: password, example: "123456" }
    
    UpdateProfileInput:
      type: object
      properties:
        fullName: { type: string }
        phoneNumber: { type: string }

    ChangePasswordInput:
      type: object
      required: [currentPassword, newPassword, confirmPassword]
      properties:
        currentPassword: { type: string }
        newPassword: { type: string }
        confirmPassword: { type: string }

    CampusInput:
      type: object
      required: [name]
      properties:
        name: { type: string }
        address: { type: string }

    FacilityTypeInput:
      type: object
      required: [name]
      properties:
        name: { type: string }
        description: { type: string }

    FacilityInput:
      type: object
      required: [name, campusId, typeId, capacity]
      properties:
        name: { type: string }
        capacity: { type: integer }
        campusId: { type: integer }
        typeId: { type: integer }
        description: { type: string }
        imageUrls: { type: array, items: { type: string } }

    ClubInput:
      type: object
      required: [code, name, campusId]
      properties:
        code: { type: string }
        name: { type: string }
        campusId: { type: integer }
        leaderEmail: { type: string, description: "Email sinh viên làm Leader" }

    ClubPriorityInput:
      type: object
      required: [facilityId, priorityScore]
      properties:
        facilityId: { type: integer }
        priorityScore: { type: integer }

    BookingInput:
      type: object
      required: [facilityId, date, slots, bookingTypeId]
      properties:
        facilityId: { type: integer }
        date: { type: string, format: date, example: "2025-10-20" }
        slots: { type: array, items: { type: integer }, example: [1, 2] }
        bookingTypeId: { type: integer }
        purpose: { type: string }
        attendeeCount: { type: integer }

    RejectInput:
      type: object
      required: [reason]
      properties:
        reason: { type: string }

    MaintenanceSetRequest:
      type: object
      required: [facilityId, startDate, reason]
      properties:
        facilityId: { type: integer }
        startDate: { type: string, format: date-time }
        endDate: { type: string, format: date-time }
        reason: { type: string }

paths:
  # ==========================================
  # TAG 1: PUBLIC & COMMON (All Users)
  # ==========================================
  /auth/login:
    post:
      summary: Đăng nhập Email/Pass
      tags: [1. Public & Common]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginInput' }
      responses:
        '200': { description: OK }

  /auth/google/login:
    get:
      summary: Đăng nhập Google (Redirect)
      tags: [1. Public & Common]
      parameters:
        - in: query
          name: campusId
          schema: { type: integer }
          required: true
      responses:
        '302': { description: Redirect }

  /auth/profile:
    get:
      summary: Xem thông tin bản thân (Who am I?)
      tags: [1. Public & Common]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: OK }

  /users/update-profile:
    patch:
      summary: Cập nhật thông tin cá nhân
      tags: [1. Public & Common]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpdateProfileInput' }
      responses:
        '200': { description: Updated }

  /users/change-password:
    patch:
      summary: Đổi mật khẩu
      tags: [1. Public & Common]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ChangePasswordInput' }
      responses:
        '200': { description: Updated }

  # ==========================================
  # TAG 2: STUDENT & LECTURER (Standard User)
  # ==========================================
  /bookings/search:
    get:
      summary: Tìm phòng trống (MW1)
      description: Hệ thống tự động lọc theo Campus của user.
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: date
          required: true
          schema: { type: string, format: date }
        - in: query
          name: slot
          required: true
          schema: { type: integer }
        - in: query
          name: typeId
          schema: { type: integer }
        - in: query
          name: capacity
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /bookings:
    post:
      summary: Tạo Booking (Đặt lẻ / Đặt CLB)
      description: Dùng chung cho Sinh viên, GV và Club Leader. Club Leader chọn bookingTypeId phù hợp để đặt sự kiện.
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BookingInput' }
      responses:
        '201': { description: Created }

  /resources/facilities:
    get:
      summary: Xem danh sách phòng (Campus của tôi)
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: typeId
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /resources/facilities/{id}:
    get:
      summary: Xem chi tiết 1 phòng
      description: Xem hình ảnh, thiết bị, sức chứa trước khi đặt.
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /facility-types:
    get:
      summary: Xem danh sách Loại phòng
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: OK }

  /clubs:
    get:
      summary: Xem danh sách CLB
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: campusId
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /clubs/{id}/priorities:
    get:
      summary: Xem phòng ưu tiên của CLB
      tags: [2. Student & Lecturer]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }

  # ==========================================
  # TAG 3: CLUB LEADER (Extended Features)
  # ==========================================
  /bookings/club-suggestions:
    get:
      summary: Gợi ý phòng ưu tiên (MW3)
      description: Chỉ dành cho Club Leader. Trả về danh sách phòng được sort theo độ ưu tiên của CLB.
      tags: [3. Club Leader]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: date
          required: true
          schema: { type: string, format: date }
        - in: query
          name: slot
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }

  # ==========================================
  # TAG 4: ADMIN OPERATIONS (Facility/Campus Admin)
  # ==========================================
  # --- Booking Management ---
  /bookings/{id}/approve:
    patch:
      summary: Duyệt đơn & Auto Hủy đơn trùng (MW4)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Approved }

  /bookings/{id}/reject:
    patch:
      summary: Từ chối đơn (MW4)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RejectInput' }
      responses:
        '200': { description: Rejected }

  /maintenance/set:
    post:
      summary: Thiết lập Bảo trì & Auto chuyển phòng (MW6)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MaintenanceSetRequest' }
      responses:
        '200': { description: Processed }

  # --- CRUD Operations ---
  /campuses:
    post:
      summary: Tạo Campus (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CampusInput' }
      responses:
        '201': { description: Created }

  /campuses/{id}:
    put:
      summary: Cập nhật Campus (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CampusInput' }
      responses:
        '200': { description: Updated }
    delete:
      summary: Xóa Campus (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Deleted }

  /facility-types:
    post:
      summary: Tạo Loại phòng (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityTypeInput' }
      responses:
        '201': { description: Created }

  /facility-types/{id}:
    put:
      summary: Cập nhật Loại phòng (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityTypeInput' }
      responses:
        '200': { description: Updated }
    delete:
      summary: Xóa Loại phòng (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Deleted }

  /facilities:
    post:
      summary: Tạo Phòng mới (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityInput' }
      responses:
        '201': { description: Created }

  /facilities/{id}:
    put:
      summary: Cập nhật Phòng (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityInput' }
      responses:
        '200': { description: Updated }
    delete:
      summary: Xóa Phòng (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Deleted }

  /clubs:
    post:
      summary: Tạo CLB & Gán Leader (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClubInput' }
      responses:
        '201': { description: Created }

  /clubs/{id}:
    put:
      summary: Cập nhật CLB (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClubInput' }
      responses:
        '200': { description: Updated }
    delete:
      summary: Xóa CLB (CRUD)
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Deleted }

  /clubs/{id}/priorities:
    post:
      summary: Gán phòng ưu tiên cho CLB
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClubPriorityInput' }
      responses:
        '200': { description: Created }

  /clubs/{id}/priorities/{facilityId}:
    delete:
      summary: Gỡ bỏ phòng ưu tiên
      tags: [4. Admin Operations]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
        - in: path
          name: facilityId
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Deleted }

  # ==========================================
  # TAG 5: SECURITY GUARD
  # ==========================================
  /bookings/guard/search:
    get:
      summary: Tìm đơn Check-in (MW5)
      description: Tìm theo Tên SV, Mã Booking. Chỉ hiện đơn APPROVED trong ngày.
      tags: [5. Security Guard]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: keyword
          schema: { type: string }
      responses:
        '200': { description: OK }

  /bookings/{id}/check-in:
    patch:
      summary: Mở cửa / Check-in (MW5)
      tags: [5. Security Guard]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }

  /bookings/{id}/check-out:
    patch:
      summary: Đóng cửa / Check-out (MW5)
      tags: [5. Security Guard]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }