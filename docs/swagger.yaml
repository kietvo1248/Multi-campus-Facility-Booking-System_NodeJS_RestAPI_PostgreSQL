openapi: 3.0.0
info:
  title: FPTU Facility Booking System API
  description: |
    Tài liệu API cho hệ thống đặt phòng FPTU Multi-campus.
    
    ### Cơ chế xác thực (Authentication)
    Hệ thống hỗ trợ 2 cách gửi Token:
    1. **Cookie (HttpOnly)**: Trình duyệt tự động gửi cookie `access_token` sau khi login.
    2. **Bearer Token**: Dùng cho Postman hoặc Test trên Swagger. Nhập token vào nút **Authorize**.
  version: 1.0.0
servers:
  - url: http://localhost:6969/api
    description: Local Development Server

# --- CẤU HÌNH BẢO MẬT ---
components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: access_token
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  # --- ĐỊNH NGHĨA DATA MODELS (SCHEMAS) ---
  schemas:
    # 1. Login & Auth
    LoginInput:
      type: object
      required: [email, password, campusId]
      properties:
        email: { type: string, format: email, example: "admin@fpt.edu.vn" }
        password: { type: string, format: password, example: "123456" }
        campusId: { type: integer, example: 2, description: "Campus ID (VD: 1=HN, 2=HCM)" }

    User:
      type: object
      properties:
        id: { type: integer, example: 1 }
        fullName: { type: string, example: "Nguyen Van A" }
        email: { type: string, example: "anv@fpt.edu.vn" }
        role: { type: string, enum: [STUDENT, LECTURER, FACILITY_ADMIN, SECURITY], example: "STUDENT" }
        campusId: { type: integer, example: 1 }
        campusName: { type: string, example: "FPTU HCM" }
        phoneNumber: { type: string, example: "0901234567" }
        isActive: { type: boolean, example: true }

    LoginResponse:
      type: object
      properties:
        message: { type: string }
        token: { type: string }
        user: { $ref: '#/components/schemas/User' }

    ErrorResponse:
      type: object
      properties:
        message: { type: string, example: "Lỗi hệ thống hoặc dữ liệu không hợp lệ." }

    # 2. User Update
    UpdateProfileInput:
      type: object
      properties:
        fullName: { type: string, minLength: 2, example: "Nguyen Van B" }
        phoneNumber: { type: string, pattern: "^[0-9]{10,11}$", example: "0987654321" }

    ChangePasswordInput:
      type: object
      required: [currentPassword, newPassword, confirmPassword]
      properties:
        currentPassword: { type: string, format: password, example: "OldPass123" }
        newPassword: { type: string, format: password, minLength: 6, example: "NewPass123" }
        confirmPassword: { type: string, format: password, example: "NewPass123" }

    # 3. Resources (Campus, Facility, Club)
    CampusInput:
      type: object
      required: [name]
      properties:
        name: { type: string, example: "FPTU Hoa Lac" }
        address: { type: string, example: "Khu CNC Hoa Lac" }

    FacilityTypeInput:
      type: object
      required: [name]
      properties:
        name: { type: string, example: "Phòng học" }
        description: { type: string }

    FacilityInput:
      type: object
      required: [name, campusId, typeId, capacity]
      properties:
        name: { type: string, example: "R101" }
        capacity: { type: integer, example: 30 }
        campusId: { type: integer }
        typeId: { type: integer }
        description: { type: string }
        imageUrls: { type: array, items: { type: string } }

    ClubInput:
      type: object
      required: [code, name, campusId]
      properties:
        code: { type: string, example: "F-Code" }
        name: { type: string, example: "FPT Code Club" }
        description: { type: string }
        campusId: { type: integer }
        leaderId: { type: integer, nullable: true }

    ClubPriorityInput:
      type: object
      required: [facilityId, priorityScore]
      properties:
        facilityId: { type: integer }
        priorityScore: { type: integer, description: "Điểm ưu tiên (VD: 100)" }
        note: { type: string }

    # 4. Maintenance
    MaintenanceSetRequest:
      type: object
      required: [facilityId, startDate, reason]
      properties:
        facilityId: { type: integer, example: 1 }
        startDate: { type: string, format: date-time, example: "2025-12-12T13:00:00Z" }
        endDate: { type: string, format: date-time, nullable: true }
        reason: { type: string, example: "Sửa máy lạnh" }

    MaintenanceSetResponse:
      type: object
      properties:
        maintenanceId: { type: integer }
        totalAffected: { type: integer }
        results:
          type: array
          items:
            type: object
            properties:
              bookingId: { type: integer }
              action: { type: string, enum: [RELOCATED, CANCELLED] }
              toFacilityId: { type: integer, nullable: true }

    # 5. Booking
    BookingInput:
      type: object
      required: [facilityId, date, slots, bookingTypeId]
      properties:
        facilityId: { type: integer, example: 1 }
        date: { type: string, format: date, example: "2025-12-20" }
        slots: { type: array, items: { type: integer }, example: [1, 2] }
        bookingTypeId: { type: integer, example: 1 }
        purpose: { type: string, example: "Họp CLB" }
        attendeeCount: { type: integer, example: 20 }

    BookingResponse:
      type: object
      properties:
        id: { type: integer }
        status: { type: string, example: "PENDING" }
        startTime: { type: string, format: date-time }
        endTime: { type: string, format: date-time }

# --- ĐỊNH NGHĨA CÁC API (PATHS) ---
paths:
  # ==================================
  # GROUP 1: AUTHENTICATION
  # ==================================
  /auth/login:
    post:
      summary: Đăng nhập thường (bắt buộc chọn campus)
      tags: [Authentication]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginInput' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/LoginResponse' }
        '400':
          description: Thiếu email/password/campusId hoặc campusId không hợp lệ
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '401':
          description: Sai email hoặc mật khẩu
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '403':
          description: Không thuộc campus đã chọn / tài khoản bị vô hiệu hóa / tài khoản Google-only
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /auth/google/login:
    get:
      summary: Login Google (Redirect)
      tags: [Authentication]
      security: []
      parameters:
        - in: query
          name: campusId
          schema: { type: integer }
          required: true
      responses:
        '302': { description: Redirect to Google }

  /auth/google/callback:
    get:
      summary: Login Google Callback
      tags: [Authentication]
      security: []
      parameters:
        - in: query
          name: code
          schema: { type: string }
        - in: query
          name: state
          schema: { type: string }
      responses:
        '302': { description: Redirect to Frontend }

  /auth/profile:
    get:
      summary: Xem profile hiện tại
      tags: [Authentication]
      security: [{ cookieAuth: [] }, { bearerAuth: [] }]
      responses:
        '200':
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { description: Unauthorized }

  # ==================================
  # GROUP 2: USER MANAGEMENT
  # ==================================
  /users/update-profile:
    patch:
      summary: Cập nhật thông tin (Tên, SĐT)
      tags: [User Management]
      security: [{ cookieAuth: [] }, { bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpdateProfileInput' }
      responses:
        '200':
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }

  /users/change-password:
    patch:
      summary: Đổi mật khẩu
      tags: [User Management]
      security: [{ cookieAuth: [] }, { bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ChangePasswordInput' }
      responses:
        '200':
          description: Thành công
          content:
            application/json:
              example: { "message": "Đổi mật khẩu thành công." }
        '400': { description: Lỗi validate }

  # ==================================
  # GROUP 3: MAINTENANCE (FACILITY_ADMIN)
  # ==================================
  /maintenance/set:
    post:
      summary: Thiết lập bảo trì (Tự động xử lý booking)
      tags: [Maintenance]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MaintenanceSetRequest' }
      responses:
        '200':
          content:
            application/json:
              schema: { $ref: '#/components/schemas/MaintenanceSetResponse' }
        '403': { description: Forbidden }

  # ==================================
  # GROUP 4: RESOURCES (CRUD)
  # ==================================
  /campuses:
    get:
      summary: Lấy danh sách Campus
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: OK }
    post:
      summary: Tạo Campus
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CampusInput' }
      responses:
        '201': { description: Created }

  /campuses/{id}:
    put:
      summary: Cập nhật Campus
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CampusInput' }
      responses:
        '200': { description: Updated }
    delete:
      summary: Xóa (Soft delete) Campus
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Deleted }

  /facility-types:
    get:
      summary: Lấy danh sách loại phòng
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: OK }
    post:
      summary: Tạo loại phòng
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityTypeInput' }
      responses:
        '201': { description: Created }

  /facility-types/{id}:
    put:
      summary: Cập nhật loại phòng
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityTypeInput' }
      responses:
        '200': { description: Updated }
    delete:
      summary: Xóa (Soft delete) loại phòng
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Deleted }

  /facilities:
    get:
      summary: Lấy danh sách phòng
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: campusId
          schema: { type: integer }
        - in: query
          name: typeId
          schema: { type: integer }
      responses:
        '200': { description: OK }
    post:
      summary: Tạo phòng mới
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityInput' }
      responses:
        '201': { description: Created }

  /facilities/{id}:
    put:
      summary: Cập nhật phòng
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FacilityInput' }
      responses:
        '200': { description: Updated }
    delete:
      summary: Xóa (Soft delete) phòng
      tags: [Resources]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Deleted }

  # ==================================
  # GROUP 5: CLUBS & PRIORITIES
  # ==================================
  /clubs:
    get:
      summary: Lấy danh sách CLB
      tags: [Clubs]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: campusId
          schema: { type: integer }
      responses:
        '200': { description: OK }
    post:
      summary: Tạo CLB mới
      tags: [Clubs]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClubInput' }
      responses:
        '201': { description: Created }

  /clubs/{id}:
    put:
      summary: Cập nhật CLB
      tags: [Clubs]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClubInput' }
      responses:
        '200': { description: Updated }
    delete:
      summary: Xóa CLB
      tags: [Clubs]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Deleted }

  /clubs/{id}/priorities:
    get:
      summary: Xem quyền ưu tiên phòng của CLB
      tags: [Clubs]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        '200': { description: OK }
    post:
      summary: Gán quyền ưu tiên phòng cho CLB
      tags: [Clubs]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClubPriorityInput' }
      responses:
        '200': { description: Assigned }

  /clubs/{id}/priorities/{facilityId}:
    delete:
      summary: Gỡ quyền ưu tiên
      tags: [Clubs]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
        - in: path
          name: facilityId
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Removed }

  # ==================================
  # GROUP 6: BOOKINGS
  # ==================================
  /bookings/search:
    get:
      summary: Tìm phòng trống
      tags: [Bookings]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: date
          schema: { type: string, format: date }
          required: true
        - in: query
          name: slot
          schema: { type: integer }
          required: true
        - in: query
          name: typeId
          schema: { type: integer }
        - in: query
          name: capacity
          schema: { type: integer }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/FacilityInput' }

  /bookings:
    post:
      summary: Tạo yêu cầu đặt phòng
      tags: [Bookings]
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BookingInput' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/BookingResponse' }

  /bookings/club-suggestions:
    get:
      summary: Gợi ý phòng cho CLB (dựa trên Priority)
      tags: [Bookings]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: date
          schema: { type: string, format: date }
          required: true
        - in: query
          name: slot
          schema: { type: integer }
          required: true
      responses:
        '200':
          description: OK
